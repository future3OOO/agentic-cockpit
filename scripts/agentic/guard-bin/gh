#!/usr/bin/env bash
set -euo pipefail

# Agentic Cockpit guard for worker agents.
#
# Purpose: prevent background Codex workers (including daddy-autopilot) from merging PRs
# or performing other high-risk governance actions without explicit human instruction.
#
# Interactive DADDY CHAT is *not* launched through this wrapper; only worker agents are.

ORIG_PATH="${VALUA_ORIG_PATH:-}"
if [[ -z "${ORIG_PATH}" ]]; then
  ORIG_PATH="${PATH}"
fi

REAL_GH="${VALUA_REAL_GH:-}"
if [[ -z "${REAL_GH}" ]]; then
  REAL_GH="$(PATH="${ORIG_PATH}" command -v gh 2>/dev/null || true)"
fi

if [[ -z "${REAL_GH}" ]]; then
  echo "COCKPIT GUARD: gh not found in PATH" >&2
  exit 127
fi

block_merge() {
  echo "COCKPIT GUARD: blocked GitHub PR merge for worker agents." >&2
  echo "PR merges must be performed via the interactive DADDY CHAT with explicit user approval." >&2
  exit 49
}

# Block `gh pr merge` (incl. `--auto`) for all worker agents.
if [[ "${1:-}" == "pr" && "${2:-}" == "merge" ]]; then
  echo "COCKPIT GUARD: blocked 'gh pr merge' for worker agents." >&2
  echo "PR merges must be performed via the interactive DADDY CHAT with explicit user approval." >&2
  exit 49
fi

# Block API-based merges / auto-merge enables (these bypass `gh pr merge`).
if [[ "${1:-}" == "api" ]]; then
  for a in "$@"; do
    if [[ "${a}" == *"mergePullRequest"* || "${a}" == *"enablePullRequestAutoMerge"* ]]; then
      block_merge
    fi
    if [[ "${a}" =~ (^|/)pulls/[0-9]+/merge($|\\?|/) ]]; then
      block_merge
    fi
  done
fi

exec "${REAL_GH}" "$@"
