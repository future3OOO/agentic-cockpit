{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Opus Consult Request Payload",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "consultId",
    "round",
    "maxRounds",
    "mode",
    "autopilotHypothesis",
    "autopilotMessage",
    "taskContext",
    "priorRoundSummary",
    "questions"
  ],
  "properties": {
    "version": {
      "type": "string",
      "enum": ["v1"]
    },
    "consultId": {
      "type": "string",
      "minLength": 1,
      "maxLength": 160
    },
    "round": {
      "type": "integer",
      "minimum": 1,
      "maximum": 200
    },
    "maxRounds": {
      "type": "integer",
      "minimum": 1,
      "maximum": 200
    },
    "mode": {
      "type": "string",
      "enum": ["pre_exec", "post_review"]
    },
    "autopilotHypothesis": {
      "type": "object",
      "additionalProperties": false,
      "required": ["summary", "intendedActions", "proposedDispatches"],
      "properties": {
        "summary": {
          "type": "string",
          "minLength": 1,
          "maxLength": 2000
        },
        "intendedActions": {
          "type": "array",
          "minItems": 1,
          "maxItems": 24,
          "items": {
            "type": "string",
            "minLength": 1,
            "maxLength": 500
          }
        },
        "proposedDispatches": {
          "type": "array",
          "maxItems": 24,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["to", "kind", "phase", "title", "reason"],
            "properties": {
              "to": {
                "type": "array",
                "minItems": 1,
                "maxItems": 8,
                "items": {
                  "type": "string",
                  "minLength": 1,
                  "maxLength": 120
                }
              },
              "kind": {
                "type": "string",
                "minLength": 1,
                "maxLength": 120
              },
              "phase": {
                "type": "string",
                "minLength": 1,
                "maxLength": 120
              },
              "title": {
                "type": "string",
                "minLength": 1,
                "maxLength": 280
              },
              "reason": {
                "type": "string",
                "minLength": 1,
                "maxLength": 1200
              }
            }
          }
        }
      }
    },
    "autopilotMessage": {
      "type": ["string", "null"],
      "maxLength": 8000
    },
    "taskContext": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "taskId",
        "taskKind",
        "title",
        "bodySummary",
        "rootId",
        "parentId",
        "sourceKind",
        "smoke",
        "referencesSummary",
        "packetMeta",
        "lineage",
        "references"
      ],
      "properties": {
        "taskId": { "type": "string", "minLength": 1, "maxLength": 240 },
        "taskKind": { "type": "string", "minLength": 1, "maxLength": 120 },
        "title": { "type": "string", "minLength": 1, "maxLength": 500 },
        "bodySummary": { "type": "string", "minLength": 1, "maxLength": 8000 },
        "rootId": { "type": ["string", "null"], "maxLength": 240 },
        "parentId": { "type": ["string", "null"], "maxLength": 240 },
        "sourceKind": { "type": ["string", "null"], "maxLength": 120 },
        "smoke": { "type": "boolean" },
        "referencesSummary": { "type": "string", "minLength": 1, "maxLength": 8000 },
        "packetMeta": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "id",
            "from",
            "to",
            "priority",
            "title",
            "kind",
            "phase",
            "notifyOrchestrator"
          ],
          "properties": {
            "id": { "type": "string", "minLength": 1, "maxLength": 240 },
            "from": { "type": "string", "minLength": 1, "maxLength": 120 },
            "to": {
              "type": "array",
              "minItems": 1,
              "maxItems": 8,
              "items": {
                "type": "string",
                "minLength": 1,
                "maxLength": 120
              }
            },
            "priority": { "type": "string", "minLength": 1, "maxLength": 40 },
            "title": { "type": "string", "minLength": 1, "maxLength": 500 },
            "kind": { "type": "string", "minLength": 1, "maxLength": 120 },
            "phase": { "type": ["string", "null"], "maxLength": 120 },
            "notifyOrchestrator": { "type": "boolean" }
          }
        },
        "lineage": {
          "type": "object",
          "additionalProperties": false,
          "required": ["rootId", "parentId", "sourceKind", "from"],
          "properties": {
            "rootId": { "type": ["string", "null"], "maxLength": 240 },
            "parentId": { "type": ["string", "null"], "maxLength": 240 },
            "sourceKind": { "type": ["string", "null"], "maxLength": 120 },
            "from": { "type": ["string", "null"], "maxLength": 120 }
          }
        },
        "references": {
          "type": "object",
          "maxProperties": 128
        }
      }
    },
    "priorRoundSummary": {
      "type": ["string", "null"],
      "maxLength": 8000
    },
    "questions": {
      "type": "array",
      "maxItems": 24,
      "items": {
        "type": "string",
        "maxLength": 800
      }
    }
  }
}
